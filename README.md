# **Тестовое задание**
В данном тестовом задании вам потребуется реализовать API, состоящее из 3-х сервисов, взаимодействующих с базой данных и другим API(имитация сторонней системы).  
В качестве тестового окружения можно использовать представленный docker-compose.

Доп. требования к результату выполнения:
- результат выполнения должен быть представлен на github;
- приложение должно билдиться в docker image; 
- возможность задания endpoint внешней системы({host}:{port}) через переменные окружения;
- возможность задания строки подключения к БД через переменную окружения;
- в случае реализации на c# использовать .net core 3.1 и для взаимодействия с БД - EFCore;
- в случае реализации на java использовать jdk 8/11, Spring Boot, для взаимодействия с БД - Spring Data JPA.

## **Описание требований к сервисам**

### **Сервис создания новой записи СreateObject**  
Сервис должен работать как через Get, так и через Post.  
На входе принимает: 
> Поле | Тип | Описание
> --- | --- |---
> Name | строка | Имя запрашивающей стороны
> dataType | строка | Тип объекта ( phone, email, other)

По dataType получает новый обект из [API сторонней системы](#api) и сохраняет его в БД.

Сервис возвращает Guid полученного объекта.

Пример вызова:

``` Get http://{host}:{port}/Api/СreateObject?Name=test&dataType=phone ```  

Или
``` Post http://{host}:{port}/Api/СreateObject```
``` json
{
"name":"test",
"dataType":"phone"
}
```
В ответ:

``` d483776a-c8a8-456a-ac68-742cd03fcbbf ```
### **Сервис получения файла - GetFileById**

Сервсиc должен работать только через **Get**.  
По Id, полученному в первом сервисе, выгружает файл, если он есть,
в противном случае возвращает 404 статус + описание. 

Входные данные:
> Поле | Тип | Описание
> --- | --- |---
> id | Guid | Id объекта, для которого запрашивается файл


В ответ поток с файлом (имя и расширение файла должно быть сохранено относительно возвращаемого сервисом GetFile API сторонней системы).

Либо если не найден объект:

 - 404 + *Запрашиваемый объект не найден*.

Если у объекта нет файла: 

 - 404 + *У запрашиваемого объекта отсутсвует файл*.

Пример:

``` Get http://{host}:{port}/Api/GetFileById?id=d483776a-c8a8-456a-ac68-742cd03fcbbf ```


### **Сервис получения статистики - GetStats**

Сервсиc должен работать только через Get.
Возвращает общую статистику по сохраненным в базу объектам в виде json.
Описание структуры:

> Поле | Тип | Описание
> --- | --- |---
> PhoneCount | число | Количество объектов типа phone
> PhoneCountWhitFile | число | Количество объектов типа phone, к которым прикреплен файл
> TopPhones | строка | 10 последних телефонных номеров через ;
> EmailСount | число | Количество объектов типа email
> EmailCountWhitFile | число | Количество объектов типа email, к которым прикреплен файл
> TopEmails | строка | 10 последних email через ;
> OhterCount | число | Количество объектов типа other
> OhterCountWhitFile | число | Количество объектов типа other, к которым прикреплен файл

Пример ниже.

Запрос:

```Get http://{host}:{port}/Api/GetStats```  
Ответ:

```json
{
    "PhoneCount":"1",
    "PhoneCountWhitFile":"1",
    "TopPhones":"88008008000;88008008001",
    "EmailСount":"1",
    "EmailCountWhitFile":"1",
    "TopEmails":"test@test.com;test1@.test.com",
    "OhterCount":"10",
    "OhterCountWhitFile":"15",
   }
```

## **Описание API сторонней системы**<a name="api"></a>

Веб-приложение доступно в виде docker image *erthsobes/erthsobesservis*.

Оно слушает внутри контейнера порт 6500.

У приложения доступен swagger */swagger/index.html*.

Api состоит из 2-х сервисов, приведенных ниже.

### **Сервис получения нового объекта по его типу - GetObjectInfo**

Является Get сервисом, который на входе принимает тип запрашиваемого объекта:
phone, email или 0, 1.  
 Все, что не относится к перечисленному, будет отнесено к типу "прочее".
В ответ сервис возвращает структуру следующего вида:

> Поле | Тип | Описание
> --- | --- |---
> dataType | строка | Тип объекта ( phone, email, other)
> data | строка | Объект в виде json 
> Error | строка | В случае ошибки здесь будет ее описание

Возможные объекты в поле data:

1. Телефонный номер

    > Поле | Тип | Описание
    > --- | --- |---
    > Id | Guid | Уникальный идентификатор объекта
    > Cost | decimal | Цена
    > PhoneNumber | строка | Номер телефона
    > File | object | Описание файла вложения

2. Email
    > Поле | Тип | Описание
    > --- | --- |---
    > Id | Guid | Уникальный идентификатор объекта
    > Cost | decimal | Цена
    > Email | строка | Email адрес
    > File | object | Описание файла вложения

3. Прочее
    > Поле | Тип | Описание
    > --- | --- |---
    > Id | Guid | Уникальный идентификатор объекта
    > Cost | decimal | Цена
    > Value | строка | Описание объекта
    > File | object | Описание файла вложения

 Структура объекта **File**:<a name="fileStructure"></a>

> Поле | Тип | Описание
> --- | --- |---
> Id | число | Может быть очень большим
> Hash | строка | Хеш, использующийся при запросе файла

Коды возврата:

    - 200 - если все ок;
    - 500 - в случае ошибки.


Примеры вызова:

Запрос:

``` Get http://{host}:{port}/api/GetObjectInfo?type=phone```

Ответ :

```json
{"dataType":"phone","data":"{\"PhoneNumber\":\"89392975637\",\"Id\":\"34b57891-71ce-43e7-b49f-b243d7f851e6\",\"Cost\":79.58}"}
```
```json
{"dataType":"phone","data":"{\"PhoneNumber\":\"89897797065\",\"Id\":\"d483776a-c8a8-456a-ac68-742cd03fcbbf\",\"Cost\":0.17,\"File\":{\"Id\":323456789123456789,\"Hash\":\"f5e95e995d1ed66f727d2b8136ee7db679889e0b7fb7ca49d0bd407840a3a8e1\"}}"}
```

### **Сервис выгрузки файла - GetFile**

Является Post сервисом, который по Id файла и hash возвращает файл.

На входе json объект типа [File](#fileStructure).

На выходе поток с содержимым файла.

Коды возврата:

    - 200 - если все ок;
    - 403 - в случае некорректного hash;
    - 404 - в случае отсутствия файла;
    - 500 - в случае ошибки.

Пример ниже.

Запрос:
``` POST http://{host}:{port}/Api/GetFile ```
```json
{
	"id":1,
	"hash":"c8293c1122925a4a56ef572d280ffe587f5f003917b621b3166ab0bce438a793"
}
```

## **Описание БД**

В качестве СУБД используется PostgreSQL 12.4.   
Название базы - **orders**.  
### **Структура**
- Таблица **order_info**

> Поле | Тип | Описание
> --- | --- |---
> id | bigint | PK
> product_id | uuid | Уникальный идентификатор объекта
> type | varchar | Тип объекта ( phone, email, other)
> cost | numeric | Цена
> phoneNumber | varchar | Номер телефона
> email | varchar | Email адрес
> value | varchar | Описание объекта
> attachment_id | bigint | FK на attachment
- Таблица **attachment**
> Поле | Тип | Описание
> --- | --- |---
> id | uuid | Уникальный идентификатор объекта
> hash | varchar | Хеш, использующийся при запросе файла

